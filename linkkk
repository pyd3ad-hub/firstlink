--[[
	WARNING: Heads up! This script has not been verified by ScriptBlox. Use at your own risk!
]]
-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local AvatarEditor = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Player reference
local plr = Players.LocalPlayer

-- Position saving configuration
local CONFIG_FILE = "KeystrokeUIPos.txt"
local savedPositions = {}

-- Load saved positions
if isfile and isfile(CONFIG_FILE) then
	local success, result = pcall(function()
		return HttpService:JSONDecode(readfile(CONFIG_FILE))
	end)
	if success and type(result) == "table" then
		savedPositions = result
	end
end

-- Save positions function
local function saveConfig()
	if writefile then
		writefile(CONFIG_FILE, HttpService:JSONEncode(savedPositions))
	end
end

-- Check if UI is already running (reload detection)
local existingGui = CoreGui:FindFirstChild("KeystrokeUI")
local existingDetection = ReplicatedStorage:FindFirstChild("juisdfj0i32i0eidsuf0iok")

if existingGui or existingDetection then
	-- UI is already running - show warning and prevent re-execution
	warn("⚠️ Keystroke UI is already running! Please do not reload the script.")
	
	-- Show a notification if possible
	if plr and plr:FindFirstChild("PlayerGui") then
		local notificationGui = Instance.new("ScreenGui")
		notificationGui.Name = "KeystrokeUI_Warning"
		notificationGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
		notificationGui.Parent = plr.PlayerGui
		
		local notificationFrame = Instance.new("Frame")
		notificationFrame.Size = UDim2.new(0, 400, 0, 100)
		notificationFrame.Position = UDim2.new(0.5, -200, 0.5, -50)
		notificationFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
		notificationFrame.BackgroundTransparency = 0.2
		notificationFrame.BorderSizePixel = 0
		notificationFrame.Parent = notificationGui
		
		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(0, 8)
		corner.Parent = notificationFrame
		
		local stroke = Instance.new("UIStroke")
		stroke.Color = Color3.fromRGB(255, 100, 100)
		stroke.Thickness = 2
		stroke.Parent = notificationFrame
		
		local title = Instance.new("TextLabel")
		title.Size = UDim2.new(1, -20, 0, 30)
		title.Position = UDim2.new(0, 10, 0, 10)
		title.BackgroundTransparency = 1
		title.Text = "⚠️ UI Already Running"
		title.TextColor3 = Color3.fromRGB(255, 100, 100)
		title.Font = Enum.Font.GothamBold
		title.TextSize = 16
		title.TextXAlignment = Enum.TextXAlignment.Left
		title.Parent = notificationFrame
		
		local message = Instance.new("TextLabel")
		message.Size = UDim2.new(1, -20, 0, 50)
		message.Position = UDim2.new(0, 10, 0, 40)
		message.BackgroundTransparency = 1
		message.Text = "Keystroke UI is already active. Do not reload the script."
		message.TextColor3 = Color3.fromRGB(255, 255, 255)
		message.Font = Enum.Font.Gotham
		message.TextSize = 12
		message.TextXAlignment = Enum.TextXAlignment.Left
		message.TextWrapped = true
		message.Parent = notificationFrame
		
		-- Auto-remove after 5 seconds
		task.spawn(function()
			task.wait(5)
			notificationGui:Destroy()
		end)
	end
	
	-- Stop execution here
	return
end

-- Clear any orphaned UI (safety check)
if existingGui then
	existingGui:Destroy()
end

-- UI Elements
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KeystrokeUI"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = CoreGui

local Frame = Instance.new("Frame")
Frame.Parent = ScreenGui
Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Frame.BackgroundTransparency = 0.4
Frame.BorderSizePixel = 0
-- Load saved position if available, otherwise use default
if savedPositions["KeystrokeUI_Frame"] then
	local posData = savedPositions["KeystrokeUI_Frame"]
	Frame.Position = UDim2.new(posData.Xs, posData.Xo, posData.Ys, posData.Yo)
else
	Frame.Position = UDim2.new(0.77, 0, 0.15, 0)
end
Frame.Size = UDim2.new(0, 120, 0, 120)
Frame.Active = true  -- for dragging

local UICorner = Instance.new("UICorner")
UICorner.Parent = Frame

local UIStroke = Instance.new("UIStroke")
UIStroke.Parent = Frame
UIStroke.Thickness = 2
UIStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
UIStroke.Color = Color3.fromRGB(0, 0, 0)  -- Dark black color

-- Key Definitions
local keys = {
	{Name = "W", KeyCode = Enum.KeyCode.W, Position = UDim2.new(0.364, 0, 0.04, -2)},
	{Name = "A", KeyCode = Enum.KeyCode.A, Position = UDim2.new(0.035, 0, 0.364, -2)},
	{Name = "S", KeyCode = Enum.KeyCode.S, Position = UDim2.new(0.364, 0, 0.364, -2)},
	{Name = "D", KeyCode = Enum.KeyCode.D, Position = UDim2.new(0.688, 0, 0.364, -2)},
	{Name = "LMB", InputType = Enum.UserInputType.MouseButton1, Position = UDim2.new(0.035, -1, 0.64, 1), Size = UDim2.new(0, 55, 0, 18)},
	{Name = "RMB", InputType = Enum.UserInputType.MouseButton2, Position = UDim2.new(0.53, -1, 0.64, 1), Size = UDim2.new(0, 55, 0, 18)},
	{Name = "Spacebar", KeyCode = Enum.KeyCode.Space, Position = UDim2.new(0.05, -1, 0.81, 2), Size = UDim2.new(0, 110, 0, 18)},
	{Name = "F", KeyCode = Enum.KeyCode.F, Position = UDim2.new(0.688, 0, 0.04, -2), IsActionButton = true}
}

-- Key Buttons
local buttons = {}
for _, keyData in pairs(keys) do
	local keyButton = Instance.new("TextButton")
	local buttonUICorner = Instance.new("UICorner")
	local buttonUIStroke = Instance.new("UIStroke")
	
	keyButton.Name = keyData.Name
	keyButton.Parent = Frame
	keyButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	keyButton.BackgroundTransparency = 0.5
	keyButton.BorderSizePixel = 0
	keyButton.Position = keyData.Position
	keyButton.Size = keyData.Size or UDim2.new(0, 32, 0, 32)
	keyButton.Font = Enum.Font.GothamBold
	keyButton.Text = keyData.Name
	keyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	keyButton.TextSize = 14
	keyButton.TextWrapped = true
	keyButton.AutoButtonColor = false
	
	buttonUICorner.Parent = keyButton
	
	-- Add dark purple stroke to each button
	buttonUIStroke.Parent = keyButton
	buttonUIStroke.Thickness = 1.5
	buttonUIStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	buttonUIStroke.Color = Color3.fromRGB(0, 0, 0)  -- Dark black color
	
	buttons[keyData.Name] = keyButton
	
	-- Add click functionality for action buttons
	if keyData.IsActionButton then
		-- F button will be handled separately with fling functionality
	end
end

-- R6/R15 Toggle Button (positioned to the left of W)
local currentRigMode = "R6"
local rigToggleButton = Instance.new("TextButton")
local rigButtonUICorner = Instance.new("UICorner")
local rigButtonUIStroke = Instance.new("UIStroke")

rigToggleButton.Name = "RigToggle"
rigToggleButton.Parent = Frame
rigToggleButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
rigToggleButton.BackgroundTransparency = 0.5
rigToggleButton.BorderSizePixel = 0
rigToggleButton.Position = UDim2.new(0.035, 0, 0.04, -2)
rigToggleButton.Size = UDim2.new(0, 32, 0, 32)
rigToggleButton.Font = Enum.Font.GothamBold
rigToggleButton.Text = currentRigMode
rigToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
rigToggleButton.TextSize = 10
rigToggleButton.TextWrapped = true
rigToggleButton.AutoButtonColor = false

rigButtonUICorner.Parent = rigToggleButton

rigButtonUIStroke.Parent = rigToggleButton
rigButtonUIStroke.Thickness = 1.5
rigButtonUIStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
rigButtonUIStroke.Color = Color3.fromRGB(0, 0, 0)

-- Toggle functionality
rigToggleButton.MouseButton1Click:Connect(function()
	local newRigType = currentRigMode == "R6" and "R15" or "R6"
	
	task.spawn(function()
		local char = Players.LocalPlayer.Character
		if not char then return end
		
		local humanoid = char:FindFirstChildOfClass("Humanoid")
		if not humanoid then return end

		local desc = humanoid.HumanoidDescription:Clone()
		
		AvatarEditor:PromptSaveAvatar(desc, Enum.HumanoidRigType[newRigType])
		local result = AvatarEditor.PromptSaveAvatarCompleted:Wait()
		
		if result == Enum.AvatarPromptResult.Success then
			currentRigMode = newRigType
			rigToggleButton.Text = newRigType
			
			humanoid.Health = 0
			humanoid:ChangeState(Enum.HumanoidStateType.Dead)
			
			Players.LocalPlayer.CharacterAdded:Wait()
			task.wait(1)
			
			local newHumanoid = Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
			if newHumanoid then
				newHumanoid:ApplyDescription(desc)
				newHumanoid:BuildRigFromDescription(desc, Enum.HumanoidRigType[newRigType])
			end
		end
	end)
end)

-- Long Press / Long Click Detection
local longPressThreshold = 0.01
local keyPressTimes = {}

UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	for _, keyData in pairs(keys) do
		-- Skip F button as it has its own toggle logic
		if keyData.Name ~= "F" then
			if (keyData.KeyCode and input.KeyCode == keyData.KeyCode) or 
			   (keyData.InputType and input.UserInputType == keyData.InputType) then
				local button = buttons[keyData.Name]
				if button then
					keyPressTimes[keyData.Name] = tick()
					-- Immediately change text to grey
					TweenService:Create(button, TweenInfo.new(0.1), {TextColor3 = Color3.fromRGB(128, 128, 128)}):Play()
					task.spawn(function()
						task.wait(longPressThreshold)
						if keyPressTimes[keyData.Name] then
							TweenService:Create(button, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(30, 30, 30)}):Play()
						end
					end)
					
				end
			end
		end
	end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	for _, keyData in pairs(keys) do
		-- Skip F button as it has its own toggle logic
		if keyData.Name ~= "F" then
			if (keyData.KeyCode and input.KeyCode == keyData.KeyCode) or 
			   (keyData.InputType and input.UserInputType == keyData.InputType) then
				local button = buttons[keyData.Name]
				if button and keyPressTimes[keyData.Name] then
					local pressDuration = tick() - keyPressTimes[keyData.Name]
					keyPressTimes[keyData.Name] = nil
					if pressDuration < longPressThreshold then
						TweenService:Create(button, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(255, 255, 255), TextColor3 = Color3.fromRGB(255, 255, 255)}):Play()
						task.wait(0.1)
						TweenService:Create(button, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(50, 50, 50), TextColor3 = Color3.fromRGB(255, 255, 255)}):Play()
					else
						TweenService:Create(button, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(50, 50, 50), TextColor3 = Color3.fromRGB(255, 255, 255)}):Play()
					end
				end
			end
		end
	end
end)

-- Draggify GUI Functionality for Main Frame
local dragging, dragStart, startPos
Frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = Frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
				
				-- Save position when drag ends
				savedPositions["KeystrokeUI_Frame"] = {
					Xs = Frame.Position.X.Scale,
					Xo = Frame.Position.X.Offset,
					Ys = Frame.Position.Y.Scale,
					Yo = Frame.Position.Y.Offset
				}
				saveConfig()
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

-- Fling functionality
local hiddenfling = true  -- On by default

-- Initialize detection object (marker to detect if script is running)
local detection = Instance.new("Decal")
detection.Name = "juisdfj0i32i0eidsuf0iok"
detection.Parent = ReplicatedStorage

-- Fling function
local function fling()
	local hrp, c, vel, movel = nil, nil, nil, 0.1
	local lp = Players.LocalPlayer

	while true do
		RunService.Heartbeat:Wait()
		if hiddenfling then
			while hiddenfling and not (c and c.Parent and hrp and hrp.Parent) do
				RunService.Heartbeat:Wait()
				c = lp.Character
				hrp = c and c:FindFirstChild("HumanoidRootPart")
			end

			if hiddenfling then
				vel = hrp.Velocity
				hrp.Velocity = vel * 10000 + Vector3.new(0, 10000, 0)
				RunService.RenderStepped:Wait()
				if c and c.Parent and hrp and hrp.Parent then
					hrp.Velocity = vel
				end
				RunService.Stepped:Wait()
				if c and c.Parent and hrp and hrp.Parent then
					hrp.Velocity = vel + Vector3.new(0, movel, 0)
					movel = movel * -1
				end
			end
		end
	end
end

-- Start fling function
task.spawn(fling)

-- F button toggle functionality
local fButton = buttons["F"]
if fButton then
	-- Set initial state (on by default - grey)
	fButton.TextColor3 = Color3.fromRGB(128, 128, 128)  -- Grey when on
	
	fButton.MouseButton1Click:Connect(function()
		hiddenfling = not hiddenfling
		if hiddenfling then
			-- On state - grey
			TweenService:Create(fButton, TweenInfo.new(0.1), {TextColor3 = Color3.fromRGB(128, 128, 128)}):Play()
		else
			-- Off state - white
			TweenService:Create(fButton, TweenInfo.new(0.1), {TextColor3 = Color3.fromRGB(255, 255, 255)}):Play()
		end
	end)
end

-- Toggle visibility with PgUp key
local isVisible = true
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if input.KeyCode == Enum.KeyCode.PageUp then
		isVisible = not isVisible
		ScreenGui.Enabled = isVisible
	end
end)
